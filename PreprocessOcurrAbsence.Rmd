---
title: "MilkweedOccurrenceBioclim"
author: "Schaler Starks"
date: "2025-04-27"
output: html_document
---

```{r Libraries}
# Install if not already
# install.packages("spocc")
# install.packages("dplyr")
#install.packages("geodata") # for climate data processing
#install.packages("terra") # for climate data processing
library(ggplot2)
library(dplyr)
library(maps)

library(spocc)
#library(raster) # unecessary if I use terra # raster::getData doesn't work, not part of R anymore
library(geodata)
library(terra)
library(sp) # generate spatial points for syriaca and speciosa occurrances
library(dismo) # for generating background points
#library(caret) # split test/train


library(leaflet)
```


```{r Load In Occurrence Data}
syriaca_inat <- read.csv("syriaca_occurrences.csv")
speciosa_inat <- read.csv("speciosa_occurrences.csv")

```
```{r Visualization from BIOCLIM_example}
occ <- bind_rows(syriaca_inat, speciosa_inat)

na_map <- map_data("world", region = c("USA", "Canada", "Mexico"))

occurrence_plot <- ggplot() +
  geom_polygon(data = na_map, aes(x = long, y = lat, group = group),
               fill = "gray90", color = "gray50") +
  geom_point(data = occ, aes(x = longitude, y = latitude, color = scientific_name), size = 2,
             alpha = 0.3) +
  scale_color_manual(values = c("Asclepias syriaca" = "orange", 
                                "Asclepias speciosa" = "lightblue")) +
  coord_fixed(1.3, xlim = c(-130, -60), ylim = c(20, 55)) +
  theme_minimal() +
  labs(title = "Occurrences of Asclepias syriaca and speciosa in North America",
       color = "scientific_name")
```

```{r Load in Speciosa}
str(occ)
```

```{r Save the Visualization}
ggsave("occurrence_map.png", plot = occurrence_plot, width = 10, height = 6, dpi = 300)
```

```{r Selecting Relevant Occurrence Data for each to dataframe}
syriaca_locale <- syriaca_inat |>
  dplyr::filter(!is.na(latitude) & !is.na(longitude)) |>
  dplyr::select(id, longitude, latitude, observed_on, place_guess, scientific_name)
speciosa_locale <- speciosa_inat |>
  dplyr::filter(!is.na(latitude) & !is.na(longitude)) |>
   dplyr::select(id, longitude, latitude, observed_on, place_guess, scientific_name)
```

```{r}
head(syriaca_locale)
```





```{r Remove Original Inat, Not needed}
rm(syriaca_inat, speciosa_inat)
```

```{r If You Wnat to Save Cleaned Data}
#write.csv(syriaca_locale, "asclepias_syriaca_cleaned.csv", row.names = FALSE)
#write.csv(speciosa_locale, "asclepias_speciosa_cleaned.csv", row.names = FALSE)
```

```{r Dates for CO2 Emmissions Later}
library(lubridate)

# change to date type
speciosa_locale$observed_on <- ymd(speciosa_locale$observed_on)
syriaca_locale$observed_on <- ymd(syriaca_locale$observed_on)

# extract the year
speciosa_locale$year <- year(speciosa_locale$observed_on)
syriaca_locale$year <- year(syriaca_locale$observed_on)

# Combine list of years
combined_years <- sort(unique(c(speciosa_locale$year, syriaca_locale$year)))

print(combined_years)

```

```{r Climate Occurrence Data}
bioclim <- geodata::worldclim_global(var = "bio", res = 2.5, path = "data/")

# to define us bounding box with new documentation
us_extent <- terra::ext(-125, -65, 25, 50)
bioclim_us <- terra::crop(bioclim, us_extent)

head(bioclim_us)
#rm(bioclim)
```


```{r Occurrence Data with Bioclim}
# Occurrence Data: Extract bioclim for Asclepias syriaca points
speciosa_locale %>%
  mutate(
    longitude = as.numeric(longitude),
    latitude = as.numeric(latitude)
  ) %>%
  na.omit() %>% # this line removes the null values
  vect(geom = c("longitude", "latitude"), crs = crs(bioclim_us)) %>%
  extract(bioclim_us, .) %>%
  mutate(presence = 1)

speciosa_locale %>%
  mutate(
    longitude = as.numeric(longitude),
    latitude = as.numeric(latitude)
  ) %>%
  na.omit() %>%
  vect(geom = c("longitude", "latitude"), crs = crs(bioclim_us)) %>% # this line instead of spatial points
  extract(bioclim_us, .) %>%
  mutate(presence = 1)
```

Researcher's note: Here I choose to generate 16 pseudoabsences for every true presence. Liu et al. (2019) found that for rare species, the number of back-ground points needs to be up to 16 times greater than the number of true presences for model accuracy to reach an asymptote. In addition, pseudo-absence points can’t fall within 4 km of an occurrence


```{r Prepping Absence Data}
# Number of pseudo-absences = 16 × number of true presences
n_pseudo_syriaca <- nrow(syriaca_locale) * 16
n_pseudo_speciosa <- nrow(speciosa_locale) * 16
```

```{r Sampling More Random Points than Needed}
set.seed(27)

# Sample background points (oversample ~2x to be safe)
bg_points <- spatSample(bioclim_us[[1]], 
                        size = (n_pseudo_syriaca + n_pseudo_speciosa) * 2, 
                        method = "random", na.rm = TRUE, xy = TRUE)

bg_vect <- vect(bg_points, 
                geom = c("x", "y"), 
                crs = crs(bioclim_us))

# Create SpatVector of presence points
syriaca_vect <- vect(syriaca_locale, 
                     geom = c("longitude", "latitude"), 
                     crs = crs(bioclim_us))
speciosa_vect <- vect(speciosa_locale, 
                      geom = c("longitude", "latitude"), 
                      crs = crs(bioclim_us))

# Combine presence points
presence_vect <- rbind(syriaca_vect, speciosa_vect)

# Calculate distance matrix
distances <- terra::distance(bg_vect, presence_vect)

# Find minimum distance from each bg point to any presence point
min_distances <- apply(distances, 1, min)

# Keep only points farther than 4km
bg_vect_far <- bg_vect[min_distances > 4000, ]
```

```{r}
# List all the .nc files
co2_files <- list.files("C:\\Users\\these\\Documents\\BIOL361\\ClimAnalysisProj2\\RelevantCO2", 
                        pattern = ".nc$", 
                        full.names = TRUE)

# Load them into a SpatRaster collection
co2_stack <- rast(co2_files)

```

```{r Now Randomly Sample Number Needed and Combine Datasets}
# Combined piped version for Syriaca
combinedSyriaca <- syriaca_locale %>%
  mutate(presence = 1) %>%
  bind_rows(
    sample(bg_vect_far, n_pseudo_syriaca) %>%
      extract(bioclim_us, .) %>%
      select(-ID) %>%  # remove extract ID column if it exists
      mutate(presence = 0)
  )

# Combined piped version for Speciosa
combinedSpeciosa <- speciosa_locale %>%
  mutate(presence = 1) %>%
  bind_rows(
    sample(bg_vect_far, n_pseudo_speciosa) %>%
      extract(bioclim_us, .) %>%
      select(-ID) %>%
      mutate(presence = 0)
  )
```


```{r Save Combined Data frame}
write.csv(combinedSyriaca, "syriaca_occurrence.csv", row.names = FALSE)
write.csv(combinedSpeciosa, "speciosa_occurrence.csv", row.names = FALSE)
```

```{r}
combinedMilkweed <- rbind(combinedSpeciosa,combinedSyriaca)
```

```{r COmebine Data with the CO2 Emissions Data}
combinedMilkweed <- combined_data %>%
  mutate(
    # Step 1: Convert observed_on to Date and extract the year
    observed_on = as.Date(observed_on, format = "%Y-%m-%d"),
    year_observed = year(observed_on)  # Extract the year from the 'observed_on' column
  ) %>%
  # Step 2: Create a SpatVector from the lat/lon columns
  mutate(coordinates = purrr::map2(longitude, latitude, ~ vect(data.frame(x = .x, y = .y), crs = crs(co2_stack_subset)))) %>%
  # Step 3: Extract the CO2 data from the corresponding year from the raster stack
  mutate(
    co2_value = purrr::map2(year_observed, coordinates, 
                            ~ extract(co2_stack_subset[[as.character(.x)]], .y)) %>%
      purrr::map_dbl(~ .x)  # Flatten the extracted list of values into a numeric vector
  )

```

```{r}
str(combinedMilkweed)
```


```{r}
write.csv(combinedMilkweed, "combinedMilkweed_with_co2.csv")
```

