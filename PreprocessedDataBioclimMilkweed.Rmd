---
title: "BINF Project"
author: "Schaler Starks"
date: "2025-04-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Notes for Anvil
- I will have to turn this into an .R script to submit via SLURM on Anvil
- Then I can use more than 1000 samples, running it on my laptop first will let me check accuracy and optimize my models


# Pipeline

1.  Collect and clean occurrence data

    1.  Asclepias syriaca and speciosa sightings with geographical location

2.  Extract bioclimactic variables

3.  Create pseudo-absences (i.e. generate background points to train model)

4.  Split Training/Test and Preprocess

5.  Train multiple base models

    1.  Random Forest Model

    2.  KNN model

    3.  GLM logistic regression model

6.  Build metabodel and average predictions

    1.  Determine accuracy with auc(roc_curve) with target \>0.7

7.  Predict climate change map:

    1.  Download future bioclim data (e.g., RCP 8.5, 2050s from WorldClim) → predict on that stack using the ensemble.

8.  Create shiny web app using leaflet to host climate show projected distributions – probability of species occurring in a region. 

    1.  Dropdown menus

        1.  Species

        2.  Severity of climate scenario

    2.  Hover: coordinate and predicted value
    
# Code

## Loading...

```{r Packages}
# Install if not already
# install.packages("spocc")
# install.packages("dplyr")
#install.packages("geodata") # for climate data processing
#install.packages("terra") # for climate data processing

library(spocc)
library(dplyr)
#library(raster) # unecessary if I use terra # raster::getData doesn't work, not part of R anymore
library(geodata)
library(terra)
library(sp) # generate spatial points for syriaca and speciosa occurrances
library(dismo) # for generating background points
library(caret) # split test/train


library(leaflet)

```

```{r setwd}
setwd("C:\\Users\\these\\Documents\\BIOL361\\ClimAnalysisProj")

```

```{r Data}
# Download occurrence data from iNaturalist for species
syriaca_raw <- occ(query = "Asclepias syriaca", from = "inat", limit = 1000)
speciosa_raw <- occ(query = "Asclepias speciosa", from = "inat", limit = 1000)
```
```{r Check Data}
#head(speciosa_raw)
class(occ2df(syriaca_raw))
```
## Cleaning

```{r}
# Making data frames
syriaca_df <- occ2df(syriaca_raw) %>%
  dplyr::filter(!is.na(latitude) & !is.na(longitude)) %>%
  dplyr::select(name, longitude, latitude, date)

speciosa_df <- occ2df(speciosa_raw) %>%
  dplyr::filter(!is.na(latitude) & !is.na(longitude)) %>%
  dplyr::select(name, longitude, latitude, date)

# only worked if I specified everything 
```

```{r}
# Check a sample of the data
head(syriaca_df)
```

```{r}
colnames(syriaca_df)
dim(syriaca_df)
```

```{r If You Want to Save to Storage}
#Save to Storage
#write.csv(syriaca_df, "asclepias_syriaca_inaturalist.csv", row.names = FALSE)
#write.csv(speciosa_df, "asclepias_speciosa_inaturalist.csv", row.names = FALSE)
```

```{r Climate Occurance Data}
#bioclim <- getData("worldclim", var = "bio", res = 2.5) 
# getData has been removed. used geodata package instead with terra for next steps
library(geodata)
#bioclim <- geodata::worldclim(var = "bio", res = 2.5, bbox = c(-125, 25, -65, 50))  # for US region only

bioclim <- geodata::worldclim_global(var = "bio", res = 2.5, path = "data/")

# to define us bounding box with new documentation
us_extent <- terra::ext(-125, -65, 25, 50)
bioclim_us <- terra::crop(bioclim, us_extent)
```

```{r}
head(bioclim_us)
rm(bioclim)
# Explanation of features: https://www.worldclim.org/data/bioclim.html
```

```{r}
dim(bioclim_us)
```


```{r Save Bioclim to Review}
# save to review later, potentially
terra::writeRaster(bioclim_us, filename = "data/bioclim_us.tif", overwrite = TRUE)
```

# Modeling

## Prepare Bioclimactic Data with Occurence Data and Pseudo-Absences
```{r Occurrence Data}
# Occurrence Data: Extract bioclim for Asclepias syriaca points
syriaca_data <- syriaca_df %>%
  mutate(
    longitude = as.numeric(longitude),
    latitude = as.numeric(latitude)
  ) %>%
  na.omit() %>% # this line removes the null values
  vect(geom = c("longitude", "latitude"), crs = crs(bioclim_us)) %>%
  extract(bioclim_us, .) %>%
  mutate(presence = 1)

speciosa_data <- speciosa_df %>%
  mutate(
    longitude = as.numeric(longitude),
    latitude = as.numeric(latitude)
  ) %>%
  na.omit() %>%
  vect(geom = c("longitude", "latitude"), crs = crs(bioclim_us)) %>% # this line instead of spatial points
  extract(bioclim_us, .) %>%
  mutate(presence = 1)
```

```{r Generating Pseudo-Absences}
set.seed(27) # create reproducible results
bg_Syriaca <- spatSample(bioclim_us[[1]], size = 2000, method = "random", na.rm = TRUE, xy = TRUE) %>%
  vect(geom = c("x", "y"), crs = crs(bioclim_us)) %>%
  extract(bioclim_us, .) %>%
  mutate(presence = 0)

bg_Speciosa <- spatSample(bioclim_us[[1]], size = 2000, method = "random", na.rm = TRUE, xy = TRUE) %>%
  vect(geom = c("x", "y"), crs = crs(bioclim_us)) %>%
  extract(bioclim_us, .) %>%
  mutate(presence = 0)
```

```{r Combining Occurrance and Absence}
combinedSyriaca_df <- bind_rows(syriaca_data, bg_Syriaca)
combinedSpeciosa_df <- bind_rows(speciosa_data, bg_Speciosa)
# check combined
```

```{r Check that Data is combined}
combinedSyriaca_df %>% 
  filter(presence == 1) %>%
  head()

```

```{r}
dim(combinedSyriaca_df)
```
```{r Save Combined Data frame}
write.csv(combinedSyriaca_df, "syriaca_occurrence.csv", row.names = FALSE)
write.csv(combinedSpeciosa_df, "speciosa_occurrence.csv", row.names = FALSE)
```

## Building Models

### Test Train Split

### Base Models



### Climate Models

## Averaging Accuracy

## Predict Future Climate

## Predict Future Presents based on Future Climate

# Deliverable: Shiny


# Links to Reference Pages for Code and Pipeline
https://github.com/jcoliver/biodiversity-sdm-lesson/blob/main/docs/instructions.md 

